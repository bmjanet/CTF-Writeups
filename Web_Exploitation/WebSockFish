This CTF challenge was WebSockFish: https://play.picoctf.org/practice/challenge/480?difficulty=2&page=1

For this challenge you had to "win in a convincing manner against this chess bot", where the chess bot is Stockfish: the hardest chess bot to beat. Initially, we thought we had to just beat the bot in order to get the flag, so we used "game.move({ color: [w or b], from: [src], to: [dest] });" and "board.position(game.fen())" in the console to force the black side into "Scholar's mate". Unfortunately, checkmating the bot did not reveal the flag.

Instead we decided to try to exploit this snippet:

-------------------------------------------CODE SOURCE--------------------------------------------------
stockfish.onmessage = function (event) {
        var message;
        // console.log(event.data);
        if (event.data.startsWith("bestmove")) {
          var bestMove = event.data.split(" ")[1];
          var srcSq = bestMove.slice(0, 2);
          var dstSq = bestMove.slice(2, 4);
          var promotion = bestMove.slice(4);

          game.move({ from: srcSq, to: dstSq, promotion: promotion });
          board.position(game.fen());
        } else if (event.data.startsWith(`info depth ${DEPTH}`)) {
          var splitString = event.data.split(" ");
          if (event.data.includes("mate")) {
            message = "mate " + parseInt(splitString[9]);
          } else {
            message = "eval " + parseInt(splitString[9]);
          }
          sendMessage(message);
        }
      };
------------------------------------------------------------------------------------------------------

This meant that as long as the web socket request began with "eval" or "mate", the fish would return a string corresponding to how the game is going. After observing the web socket activity through Burp Suite, we came to the conclusion that:
- mate [number] meant there is [number] amount of moves until checkmate
  -  if [number] was negative, it meant there are [number] moves until the user wins
  -  if [number] was positive, it meant there are [number] moves until the Stockfish wins
- eval [number] represents how the game is favored
  -  if [number] is very far from 0, one of the sides is favored
  -  if [number] is close to 0, it is a fairly even game
  -  if [number] is negative, the user is winning
  -  if [number] is positive, the Stockfish is winning

We also saw this in the code source:

-------------------------------------------CODE SOURCE--------------------------------------------------
<script>
      var ws_address = "ws://" + location.hostname + ":" + location.port + "/ws/";
      const ws = new WebSocket(ws_address);

      ws.onmessage = (event) => {
        const message = event.data;
        updateChat(message);
      };

      function sendMessage(message) {
        ws.send(message);
      }

      function updateChat(message) {
        const chatText = $("#chatText");
        chatText.text(message);
      }
    </script>
------------------------------------------------------------------------------------------------------

This means we can use wscat to connect to the websocket, and simulate the feedback from the Stockfish. We used the command "wscat -c ws://verbal-sleep.picoctf.net:61344/ws/" to remotely connect to the websocket.

Using these clues and that we can get replies when the message starts with "mate" or "eval", we tried a few things. First, we tried to input "mate -0", implying the user has mate in 0 moves, but we didn't get a flag. We tried a few more "mate" ideas, but none of them seemed to work.

We pivoted to trying to use "eval", which worked for us. Since a negative number meant the user is winning, and a number far away from 0 meant someone is winning a lot, using a negative number far away from 0 means the user is winning by a lot. I used "eval -99999999" to simulate this, and our output is seen below:

----------------------------------------------TERMINAL------------------------------------------------
~ % wscat -c ws://verbal-sleep.picoctf.net:61344/ws/
Connected (press CTRL+C to quit)
> eval -99999999
< Huh???? How can I be losing this badly... I resign... here's your flag: picoCTF{c1i3nt_s1d3_w3b_s0ck3t5_a2a9bbe9}
> 
------------------------------------------------------------------------------------------------------

This got us the flag.
